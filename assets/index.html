<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>TeamNCL</title>
  <link href= "/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://apis.skplanetx.com/tmap/js?version=1&format=javascript&appKey=35bfd940-2738-36fa-9502-f25ddde1ed96"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.js"></script>

  <style>
    #left_menu {
      float: left;
      width: 200px;
      border-right: 2px solid gray;
      margin: 0;
      padding: 1em;
    }

    #map_div {
      margin-left: 200px;
      padding: 1em;
      overflow: hidden;
    }
  </style>

  <script type="text/javascript">

    $.get("/ChargingStation?limit=1000", function(data) {
      console.log(data);
      console.log(data.length);
      var processedData = [];
      for (var i = 0; i < data.length; i++) {
        processedData.push (data[i].statNm + "\n");
      }
      document.getElementById ("rawData").innerText = processedData;
    });

    //초기화 함수
    function initTmap(){
      centerLL = new Tmap.LonLat(14145677.4, 4511257.6);
      map = new Tmap.Map({div:'map_div',
        //width:'100%',
        height:'800px',
        transitionEffect:"resize",
        animation:true
      });

      var route1X = 126.976011;
      var route1Y = 37.573611;
      var route2X = 127.002350;
      var route2Y = 37.559352;

      var param = {
        version: 1,
        startX: 126.995880,
        startY: 37.571076,
        endX: 126.872696,
        endY: 37.498363,
        passList: route1X+","+route1Y+",0,0,0_"+route2X+","+route2Y+",0,G,0",
        appKey: '35bfd940-2738-36fa-9502-f25ddde1ed96',
        reqCoordType: 'WGS84GEO',
        resCoordType: 'EPSG3857'
      };

      var urlStr = "https://apis.skplanetx.com/tmap/routes?" + $.param(param, true);

      searchRoute(urlStr+"&format=xml");
      marker(urlStr+"&format=json");
    }
    //경로 정보 로드
    function searchRoute(url){
      var routeFormat = new Tmap.Format.KML({extractStyles:true, extractAttributes:true});

      var prtcl = new Tmap.Protocol.HTTP({
        url: url,
        format:routeFormat
      });

      var routeLayer = new Tmap.Layer.Vector("route", {protocol:prtcl, strategies:[new Tmap.Strategy.Fixed()]});
      routeLayer.events.register("featuresadded", routeLayer, onDrawnFeatures);
      map.addLayer(routeLayer);
    }
    //경로 그리기 후 해당영역으로 줌
    function onDrawnFeatures(e){
      map.zoomToExtent(this.getDataExtent());
    }

    function marker(url) {
      var markerLayer = new Tmap.Layer.Markers( "MarkerLayer" );
      map.addLayer(markerLayer);

      $.get(url, function(data) {
        var routes = [];

        for(var i in data.features) {
          var coordinates = data.features[i].geometry.coordinates;

          if(data.features[i].geometry.type === "Point")
            routes.push([coordinates]);
          else
            routes.push(coordinates);
        }
        routes = _.flatten(routes);

        var i = 0;
        var addMarkerInterval = setInterval (function() {
          //console.log(routes[i][0], routes[i][1]);
          var size = new Tmap.Size(50,50);
          var offset = new Tmap.Pixel(-(size.w/2), -(size.h/2));
          var icon = new Tmap.Icon('vehicle.png', size, offset);
          var markers = new Tmap.Marker(new Tmap.LonLat(routes[i][0], routes[i][1]), icon);

          markerLayer.addMarker(markers);

          var removeMarkerInterval = setInterval(function() {
            markerLayer.removeMarker(markers);
          }, 1100);

          i++;

          if (i == routes.length-8) {
            clearInterval (addMarkerInterval);
            clearInterval (removeMarkerInterval);
          }
        }, 1000);
      });
    }
  </script>
</head>
<body onload="initTmap()">
<!--Top Side-->
<nav class ="navbar navbar-default navbar-fixed-top header-nav" style="margin-bottom: 0px; background: #ffffff; " role="navigation">
  <div class="container-fluid">
    <a href="#" class="navbar-brand"><b>C2V Connected Car Service Simulator</b></a>
    <p class="navbar-text"> Simulation Result Page</p>
    <img src="img_brandslogan10.gif" height="50" style="float: right;">
  </div>
</nav>

<!--Title-->
<section style="background: #0a2972; color: #ffffff; padding: 70px 0 30px 0; text-align: center;">
  <div class="container">
    <h1><b> C2V Connected Car Service Simulator Result </b></h1>
    <p style="color: #ffffff;"><br>Simulation Result Page. We provide readable data from simulation result</p>
  </div>
</section>

<!--Body-->
<section style="border-bottom: 1px solid #dedede; color: #4d5360; display: block;">
  <div id="left_menu">
    <h3 style="color: #082a61;"><b>DATA</b></h3>
    <pre id="rawData"></pre>
  </div>
  <div id="map_div"></div>
</section>

</div>
</body>
</html>
