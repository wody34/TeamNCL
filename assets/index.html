<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>simpleMap</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://apis.skplanetx.com/tmap/js?version=1&format=javascript&appKey=35bfd940-2738-36fa-9502-f25ddde1ed96"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.js"></script>
  <script type="text/javascript">
    //초기화 함수
    function initTmap(){
      centerLL = new Tmap.LonLat(14145677.4, 4511257.6);
      map = new Tmap.Map({div:'map_div',
        width:'100%',
        height:'800px',
        transitionEffect:"resize",
        animation:true
      });

      var route1X = 126.976011;
      var route1Y = 37.573611;
      var route2X = 127.002350;
      var route2Y = 37.559352;

      var param = {
        version: 1,
        startX: 126.995880,
        startY: 37.571076,
        endX: 126.872696,
        endY: 37.498363,
        passList: route1X+","+route1Y+",0,0,0_"+route2X+","+route2Y+",0,G,0",
        appKey: '35bfd940-2738-36fa-9502-f25ddde1ed96',
        reqCoordType: 'WGS84GEO',
        resCoordType: 'EPSG3857'
      };

      var urlStr = "https://apis.skplanetx.com/tmap/routes?" + $.param(param, true);

      searchRoute(urlStr+"&format=xml");
      marker(urlStr+"&format=json");
    };
    //경로 정보 로드
    function searchRoute(url){
      var routeFormat = new Tmap.Format.KML({extractStyles:true, extractAttributes:true});

      var prtcl = new Tmap.Protocol.HTTP({
        url: url,
        format:routeFormat
      });

      var routeLayer = new Tmap.Layer.Vector("route", {protocol:prtcl, strategies:[new Tmap.Strategy.Fixed()]});
      routeLayer.events.register("featuresadded", routeLayer, onDrawnFeatures);
      map.addLayer(routeLayer);
    }//
    //경로 그리기 후 해당영역으로 줌
    function onDrawnFeatures(e){
      map.zoomToExtent(this.getDataExtent());
    }

    function marker(url) {
      var markerLayer = new Tmap.Layer.Markers( "MarkerLayer" );
      map.addLayer(markerLayer);


      $.get("/ChargingStation?limit=1000", function(data) {
        console.log(JSON.stringify(data));
      });

      $.get(url, function(data) {
        var routes = [];

        for(var i in data.features) {
          var coordinates = data.features[i].geometry.coordinates;

          if(data.features[i].geometry.type === "Point")
            routes.push([coordinates]);
          else
            routes.push(coordinates);
        }
        routes = _.flatten(routes);

        var i = 0;
        var addMarkerInterval = setInterval (function() {
          //console.log(routes[i][0], routes[i][1]);
          var size = new Tmap.Size(50,50);
          var offset = new Tmap.Pixel(-(size.w/2), -(size.h/2));
          var icon = new Tmap.Icon('vehicle.png', size, offset);
          var markers = new Tmap.Marker(new Tmap.LonLat(routes[i][0], routes[i][1]), icon);

          markerLayer.addMarker(markers);

          var removeMarkerInterval = setInterval(function() {
            markerLayer.removeMarker(markers);
          }, 10);

          i++;

          if (i == routes.length-8) {
            clearInterval (addMarkerInterval);
            clearInterval (removeMarkerInterval);
          }
        }, 10);
//        for(var i = 0; i < routes.length; ++i) {
//
//        }

      });
    }
  </script>
</head>
<body onload="initTmap()">
<div id="map_div">
</div>
</body>
</html>
